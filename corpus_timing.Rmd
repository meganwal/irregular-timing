---
title: "Irregular respose times"
author: "Megan Waller and Dan Yurovsky"
date: '`r Sys.Date()`'
output:
  html_document:
  highlight: tango
theme: sandstone
code_folding: show
toc: false
toc_float: false
---
  
```{r libraries}
library(tidyverse)
library(here)
library(ggthemes)
library(glue)
library(janitor)

theme_set(theme_few(base_size = 12))

```

```{r helpers}
process_age <- function(age) {
  age_list <- sub("\\['P", "", age) %>%
    sub("D'\\]", "", .) %>%
    str_split(., "[:alpha:]") %>%
    unlist()
  
  processed_age = as.numeric(age_list[1]) * 365.25 + as.numeric(age_list[2]) * 30.5
  
  if(age_list[3] != "']") {
    processed_age = processed_age + as.numeric(age_list[3])
  }
  
  return(processed_age)
}

process_errors <- function(corpus) {
  utts <- read_csv(here(glue("data/{corpus}_utterance_data.csv"))) %>%
    mutate(error = as.logical(error),
           response_time = as.numeric(response_time)) %>%
    group_by(source_file) %>%
    mutate(age = process_age(age)) 
  

  child_data <- utts %>%
    filter(speaker == "CHI" & responder != "CHI" & (past_tense | plural ))


  child_errors <- child_data %>%
    filter(error)

  child_errors %>%
    select(source_file, age, utterance, start_time) %>%
    mutate(overreg_past = "", overreg_plural = "",
           start_time = start_time / 60) %>%
    rename(start_time_minutes = start_time) %>%
    write_csv(here(glue("tocode_data/{corpus}_tocode.csv")))
}

```

```{r braunwald, warning = FALSE}
process_errors("braunwald")
```

```{r read-errors}
read_errors <- function(corpus) {
  coded <- read_csv(here(glue("coded_data/{corpus}_coded.csv")))
  coded <- coded %>% 
    filter(overreg_past == TRUE | overreg_plural == TRUE)
  return(coded)
}
```

```{r braunwald-errors}
braunwald <- read_errors("braunwald")
```

```{r process-errors}
process_errors("sachs")
process_errors("ben")
process_errors("emily")
process_errors("emma")
process_errors("jillian")
process_errors("matt")
process_errors("roman")
```


```{r read-others-errors}
corpus_list <- c("braunwald", "sachs", "ben", "emily", "emma", 
             "jillian", "matt", "roman")

corpus_errors <- map_dfr(corpus_list, read_errors, .id = "corpus") %>%
  mutate(corpus = factor(corpus, labels = corpus_list),
         age_years = age / 365.25,
         length = str_count(utterance, " ") + 1)

# sachs <- read_errors("sachs") #8 ORs
# ben <- read_errors("ben") #3 ORs
# emily <- read_errors("emily") #31 ORs
# emma <- read_errors("emma") #18 ORs
# jillian <- read_errors("jillian") #34 ORs
# matt <- read_errors("matt") #4 ORs
# roman <- read_errors("roman") #6 ORs
```

```{r read-elan}
read_elan <- function(file, directory = here("elan_coded")) {
  read_delim(glue("{directory}/{file}"), "\t") %>%
    clean_names() %>%
    mutate(person = if_else(is.na(child_error_utterance) , "parent", "child")) %>%
    select(-child_error_utterance, -parent_error_response, -x5) %>%
    arrange(begin_time_msec) %>%
    group_by(person) %>%
    mutate(utt_num = 1:n()) %>%
    group_by(utt_num) %>%
    mutate(response_time = last(begin_time_msec) - first(end_time_msec)) %>%
    ungroup() %>%
    filter(person == "child") %>%
    mutate(corpus_file = file) %>%
    select(corpus_file, response_time, utt_num)
}
```

```{r}
elan_files <- list.files(here("elan_coded/"))

map_dfr(elan_files, read_elan) 
  

```


```{r nelson, eval = FALSE, show = FALSE}
process_errors("nelson")
#found no errors

nelson_utts <- read_csv(here(glue("data/nelson_utterance_data.csv"))) %>%
  mutate(error = as.logical(error),
         response_time = as.numeric(response_time)) %>%
  group_by(source_file) %>%
  mutate(age = process_age(age)) 

nerrors <- nelson_utts %>% filter(error == TRUE)

nelson_child_data <- nelson_utts %>%
  filter(speaker == "CHI" & responder != "CHI" & (past_tense | plural ))
nelson_child_errors <- nelson_child_data %>%
    filter(error)
```

```{r control_utts, eval = FALSE}



make_control_utts <- function(errors_df) {
  corpus <- pull(errors_df, corpus) %>% unique()
 
  utts <- read_csv(here(glue("data/{corpus}_utterance_data.csv"))) %>%
    mutate(error = as.logical(error)) %>%
    filter(!error, speaker == "CHI", responder != "CHI") %>%
    mutate(length = str_count(utterance, " ") + 1) %>%
    group_by(source_file) %>%
    mutate(age = process_age(age)) %>%
    mutate(age_months = floor(age/30.5)) %>%
    group_by(age_months, plural, past_tense, length) %>%
    nest()

  errors <- errors_df %>%
    mutate(age_months = floor(age/30.5)) %>%
    rename("past_tense" = "overreg_past",
           "plural" = "overreg_plural") %>%
    mutate_at(vars(past_tense, plural), as.character) %>%
    fuzzy_left_join(utts, 
                    by = c("age_months", "length", "plural", "past_tense"),
                    match_fun = c(~(abs(.x -.y)), ~(abs(.x -.y)),
                                  ~(as.numeric(.x==.y)), ~(as.numeric(.x==.y)))
    
   
}
```

```{r response-times, eval = FALSE}
ggplot(child_data, aes(x = response_time, color = error))  +
  geom_density()
```
